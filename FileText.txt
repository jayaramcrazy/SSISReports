pipeline {
    agent any
    environment {
        SQLSERVER = "JAYARAM\\DEVELOPER1"
        DATABASE  = "ErrorBD"
    }

    stages {
        stage('Checkout code from GitHub') {
            steps {
                checkout scm
            }
        }

        stage('Insert CSV into SQL Server') {
            steps {
                script {
                    def files = findFiles(glob: 'csvfile/Population.csv')
                    if (files.length == 0) {
                        echo " No CSV files found in ${env.CSV_DIR}"
                        error "No files to process"
                    }
                        def InsertQuery = """
                        INSERT health.population
                        FROM '${files}'                       
                        """
                        def escapedQuery = InsertQuery.replace('"', '\\"').replace('\n', ' ')
                        echo "Executing query: ${escapedQuery}"
                        bat """
                        copy csvfile\\Population1.csv C:\\Temp\\Population1.csv
                        sqlcmd -S ${env.SQLSERVER} -d ${env.DATABASE} -E -Q "${escapedQuery}"
                        """
                    }
                }
            }
        }
    }
