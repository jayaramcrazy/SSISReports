pipeline {
    agent any
    environment {
        SQLSERVER = "JAYARAM\\DEVELOPER1"   // Use your real instance
        DATABASE  = "ErrorDB"
        CSV_DIR   = 'csvfile'
    }

    stages {
        stage('Checkout code from GitHub') {
            steps {
                checkout scm
            }
        }

        stage('Insert CSV into SQL Server') {
            steps {
                script {
                    def files = findFiles(glob: "${env.CSV_DIR}/*.csv")
                    if (files.length == 0) {
                        echo " No CSV files found in ${env.CSV_DIR}"
                        error "No files to process"
                    }

                    for (file in files) {
                        def filepath = file.path.replace("/", "\\")
                        echo "Processing file: ${filepath}"

                        // Define bulk insert query correctly here
                        def bulkInsertQuery = """
                        BULK INSERT dbo.population
                        FROM '${filepath}'
                        WITH (
                            FIRSTROW = 2,
                            FIELDTERMINATOR = ',',
                            ROWTERMINATOR = '\\n',
                            TABLOCK
                        );
                        """

                        echo "Executing query:\n${bulkInsertQuery}"

                        // Run SQL query inside SQLCMD properly
                        bat """
                        sqlcmd -S ${env.SQLSERVER} -d ${env.DATABASE} -E -Q "${bulkInsertQuery.replace('"', '\\"')}"
                        """
                    }
                }
            }
        }
    }
}
