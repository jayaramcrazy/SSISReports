pipeline {
    agent any

    environment {
        SQLSERVER = "JAYARAM\\DEVELOPER1"
        DATABASE  = "ErrorBD"
    }

    stages {
        stage('Checkout from GitHub') {
            steps {
                checkout scm
            }
        }

        stage('Insert CSV data') {
            steps {
                script {
                    // Locate the CSV file in the repo
                    def csvFile = findFiles(glob: "csvfile/Population.csv")

                    if (csvFile.length == 0) {
                        error "‚ùå CSV file not found at ${csvFile}"
                    }

                    def lines = csvFile.readLines()

                    // Skip header row and insert each data row
                    for (int i = 1; i < lines.size(); i++) {
                        def columns = lines[i].split(",")

                        def country   = columns[0].trim()
                        def Capital = columns[1].trim()
                        def Population  = columns[2].trim()
                        def Area = columns[3].trim()

                        def query = """
                            INSERT INTO health.population (country, Capital, Population,Area)
                            VALUES (${country}, ${Capital}, ${Population},${Area});
                        """

                        bat """
                            sqlcmd -S ${env.SQLSERVER} -d ${env.DATABASE} -Q "${query.replace('"','\\"')}"
                        """
                    }
                }
            }
        }
    }
}
