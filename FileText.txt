pipeline {
    agent any

    environment {
        SQLSERVER = "JAYARAM\\DEVELOPER1"
        DATABASE  = "ErrorBD"
    }

    stages {
        stage('Checkout from GitHub') {
            steps {
                checkout scm
            }
        }

        stage('Insert CSV data') {
            steps {
                script {
                    // Locate the CSV file in the repo
                    def csvFile = new File("csvfile/Population.csv")

                    if (!csvFile.exists()) {
                        error "‚ùå CSV file not found at csvfile/Population.csv"
                    }

                    def lines = csvFile.readLines()

                    // Skip header row and insert each data row
                    for (int i = 1; i < lines.size(); i++) {
                        def columns = lines[i].split(",")

                        def id   = columns[0].trim()
                        def name = columns[1].trim()
                        def age  = columns[2].trim()

                        def query = """
                            INSERT INTO health.population (Id, Name, Age)
                            VALUES (${id}, '${name}', ${age});
                        """

                        bat """
                            sqlcmd -S ${env.SQLSERVER} -d ${env.DATABASE} -Q "${query.replace('"','\\"')}"
                        """
                    }
                }
            }
        }
    }
}
