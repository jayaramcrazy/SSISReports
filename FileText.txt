pipeline{
    agent any
    environment{
        SQLSERVER = "DEVELOPER1"
        DATABASE = "ErrorDB"
        CSV_DIR = 'csvfile'
    }
    stages{
        stage('checkout code from github'){
            steps{
                checkout scm
            }
        }
        stage('Inserting csv into sql server'){
            steps{
                script{
                    def files = findFiles(glob: "${env.CSV_DIR}/*.csv")
                    if (files.length == 0){
                        echo "No file found in ${env.CSV_DIR}"                    
                        error "No files to process"
                    }
                    for (file in files) {
                        def filepath = file.path.replace("/","\\")
                        echo "Processing csv files: ${filepath}"
                        //Constructing the bulk insert command
                        def bulkInsertQuery ="""
                        Bulk Insert ErrorBD.health.population from '${filepath}'
                        with(
                            FIRSTROW =2,
                            FIELDTERMINATOR = ",",
                            ROWTERMINATOR = "\n",
                            TABLOCK;"""
                         //SQL Server Contents
                         bat "sqlcmd -s ${env.SQLSERVER} -d ${env.DATABASE} -E -Q \"${bulkinsertQuery}\""
                    }
                }
            }
            
    }
}
}
