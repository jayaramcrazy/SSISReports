pipeline {
    agent any

    environment {
        SQLSERVER = 'JAYARAM\\DEVELOPER1'
        DATABASE  = 'ErrorBD'
        login     = 'JaiLogin'
        pwd       = 'Jayaram@300'
        CSV_DIR   = 'csvfile'
    }

    stages {
        stage('Checkout code from GitHub') {
            steps {
                checkout scm
            }
        }

        stage('Insert files into SQL Server') {
            steps {
                script {
                    // ðŸ”¹ Find all CSV files in the folder
                    def csvFiles = findFiles(glob: "${env.CSV_DIR}/*.csv")

                    if (csvFiles.length == 0) {
                        echo "âŒ No CSV files found in ${env.CSV_DIR}"
                    } else {
                        csvFiles.each { file ->
                            def filePath = file.path.replace('\\', '\\\\')  // escape for SQL
                            def bulkQuery = """
BULK INSERT health.Population
FROM '${filePath}'
WITH (
    FIRSTROW = 2,
    FIELDTERMINATOR = ',',
    ROWTERMINATOR = '\\n',
    TABLOCK
);
"""
                            def escapedQuery = bulkQuery.replace("\n", " ").trim()
                            echo "ðŸ“¥ Inserting data from: ${filePath}"
                            bat """
                            sqlcmd -S ${env.SQLSERVER} -d ${env.DATABASE} -U ${env.login} -P "${env.pwd}" -Q "${escapedQuery}"
                            """
                        }
                    }
                }
            }
        }
    }
}
